<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام العرض ثلاثي الأبعاد مع الاشتراكات</title>
    <script src="https://www.paypal.com/sdk/js?client-id=AZDxjDScFpQtjWTOUtWKbyN_bDt4OgqaF4eYXlewfBP4-8aqX3PiV8e1GWU6liB2CUXlkA59kJXE7M6R&currency=USD"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ccapture.js@1.1.0/build/CCapture.all.min.js"></script>
    <style>
        body {
            font-family: 'Cairo', 'Tajawal', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .auth-container {
            max-width: 500px;
            margin: 50px auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .dashboard-container {
            display: none;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #182949;
        }
        .user-menu {
            display: flex;
            align-items: center;
        }
        .btn {
            display: inline-block;
            background-color: #182949;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            margin-top: 10px;
        }
        .btn:hover {
            background-color: #0d1b36;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-success {
            background-color: #28a745;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
        }
        .error-message {
            color: #dc3545;
            margin-top: 5px;
        }
        /* تنسيق لوحة التحكم */
        .dashboard-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            flex: 1;
            margin: 0 10px;
            text-align: center;
        }
        
        .scene-container {
            background-color: #eee;
            border-radius: 8px;
            height: 400px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .export-buttons .btn {
            width: auto;
        }
        
        .export-dropdown {
            display: flex;
            flex-direction: column;
            margin: 0 5px;
        }
        
        .export-dropdown label {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .export-dropdown select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
            min-width: 120px;
        }
        
        /* نافذة معاينة الفيديو */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .close-modal {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: black;
        }
        
        .video-container {
            margin: 20px 0;
        }
        
        .video-container video {
            max-width: 100%;
            max-height: 500px;
            border-radius: 4px;
        }
        
        .modal-buttons {
            margin-top: 15px;
        }
        
        /* نافذة معاينة الفيديو */
        .video-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .video-preview-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 800px;
            width: 90%;
            position: relative;
        }
        
        .video-preview-content video {
            width: 100%;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .video-preview-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .close-preview {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #333;
        }
        
        /* تنسيق خطط الاشتراك */
        .plans-container {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .plan-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            flex: 1;
            margin: 0 10px 20px;
            min-width: 250px;
            transition: transform 0.3s ease;
        }
        
        .plan-card:hover {
            transform: translateY(-5px);
        }
        
        .plan-price {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin: 15px 0;
        }
        
        .plan-features {
            list-style-type: none;
            padding: 0;
            margin-bottom: 20px;
        }
        
        .plan-features li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .plan-features li:last-child {
            border-bottom: none;
        }
        
        .paypal-button {
            margin-top: 15px;
        }
        
        #close-plans {
            width: auto;
            margin: 0 auto;
            display: block;
        }
        
        /* مؤشر التحميل للتصدير */
        .export-status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        /* تحسين عرض الإحصائيات */
        .stat-box .progress-bar {
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .stat-box .progress-fill {
            height: 100%;
            background-color: #007bff;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .stat-box .limit-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- نموذج تسجيل الدخول -->
        <div id="login-form" class="auth-container">
            <h2>تسجيل الدخول</h2>
            <div class="form-group">
                <label for="login-email">البريد الإلكتروني</label>
                <input type="email" id="login-email" placeholder="أدخل بريدك الإلكتروني">
            </div>
            <div class="form-group">
                <label for="login-password">كلمة المرور</label>
                <input type="password" id="login-password" placeholder="أدخل كلمة المرور">
            </div>
            <div id="login-error" class="error-message"></div>
            <button id="login-button" class="btn btn-success">تسجيل الدخول</button>
            <div class="auth-toggle">
                <a href="#" id="show-register">ليس لديك حساب؟ سجل الآن</a>
            </div>
        </div>

        <!-- نموذج التسجيل -->
        <div id="register-form" class="auth-container" style="display: none;">
            <h2>إنشاء حساب جديد</h2>
            <div class="form-group">
                <label for="register-name">الاسم</label>
                <input type="text" id="register-name" placeholder="أدخل اسمك">
            </div>
            <div class="form-group">
                <label for="register-email">البريد الإلكتروني</label>
                <input type="email" id="register-email" placeholder="أدخل بريدك الإلكتروني">
            </div>
            <div class="form-group">
                <label for="register-password">كلمة المرور</label>
                <input type="password" id="register-password" placeholder="أدخل كلمة المرور">
            </div>
            <div id="register-error" class="error-message"></div>
            <button id="register-button" class="btn btn-success">إنشاء حساب</button>
            <div class="auth-toggle">
                <a href="#" id="show-login">لديك حساب بالفعل؟ سجل دخولك</a>
            </div>
        </div>

        <!-- لوحة التحكم -->
        <div id="dashboard" class="dashboard-container">
            <header>
                <div class="logo">نظام العرض ثلاثي الأبعاد</div>
                <div class="user-menu">
                    <span id="user-name"></span>
                    <button id="logout-btn" class="btn btn-danger">تسجيل الخروج</button>
                </div>
            </header>
            
            <div class="dashboard-stats">
                <div class="stat-box">
                    <h3>الخطة الحالية</h3>
                    <p id="current-plan">مجانية</p>
                    <button id="upgrade-btn" class="btn">ترقية الخطة</button>
                </div>
                <div class="stat-box">
                    <h3>الصور المستخدمة هذا الشهر</h3>
                    <p id="images-used">0</p>
                </div>
                <div class="stat-box">
                    <h3>الفيديوهات المستخدمة هذا الشهر</h3>
                    <p id="videos-used">0</p>
                </div>
                <div class="stat-box">
                    <h3>إجمالي الصور</h3>
                    <p id="total-images">0</p>
                </div>
                <div class="stat-box">
                    <h3>إجمالي الفيديوهات</h3>
                    <p id="total-videos">0</p>
                </div>
            </div>
            
            <div class="dashboard-stats">
                <div class="stat-box">
                    <h3>تفاصيل الخطة</h3>
                    <ul class="plan-details">
                        <li>الدقة: <span id="plan-resolution">2K</span></li>
                        <li>عدد الأجهزة: <span id="plan-devices">1</span></li>
                        <li>الإعلانات: <span id="plan-ads">مفعلة</span></li>
                    </ul>
                </div>
            </div>
            
            <!-- إضافة حاوية العرض ثلاثي الأبعاد -->
            <div class="scene-container" id="scene-container">
                <!-- هنا سيتم إضافة canvas ثلاثي الأبعاد -->
            </div>
            
            <!-- أزرار التصدير -->
            <div class="export-buttons">
                <div class="export-dropdown">
                    <label for="file-format">صيغة الملف:</label>
                    <select id="file-format">
                        <option value="png">PNG</option>
                        <option value="jpg">JPG</option>
                        <option value="webm">WEBM</option>
                        <option value="mp4">MP4</option>
                    </select>
                </div>
                
                <div class="export-dropdown">
                    <label for="file-dimensions">الأبعاد:</label>
                    <select id="file-dimensions">
                        <option value="1920x1080">1920x1080</option>
                        <option value="1280x720">1280x720</option>
                        <option value="800x600">800x600</option>
                        <option value="640x480">640x480</option>
                    </select>
                </div>
                
                <button id="export-image-btn" class="btn btn-success">تصدير صورة</button>
                <button id="export-video-btn" class="btn btn-success">تصدير فيديو</button>
                <button id="preview-video-btn" class="btn btn-info" style="display: none;">معاينة الفيديو</button>
            </div>
            
            <!-- نافذة معاينة الفيديو -->
            <div id="video-preview-modal" class="modal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h3>معاينة الفيديو</h3>
                    <div class="video-container">
                        <video id="preview-video" controls></video>
                    </div>
                    <div class="modal-buttons">
                        <button id="download-video-btn" class="btn btn-primary">تنزيل الفيديو</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ccapture.js@1.1.0/build/CCapture.min.js"></script>
    <script>
        // تعريف خطط الاشتراك
        const plans = {
            'free': {
                name: 'الخطة المجانية',
                monthlyImageQuota: 20,
                monthlyVideoQuota: 5,
                resolution: '2K',
                devices: 1,
                ads: true,
                price: 'مجاني',
                planId: 'free',
                features: [
                    '5 فيديوهات شهرياً',
                    '20 صورة شهرياً',
                    'دقة 2K',
                    'جهاز واحد',
                    'مع إعلانات Google'
                ]
            },
            'basic-annual': {
                name: 'الخطة الأساسية السنوية',
                monthlyImageQuota: 1000,
                monthlyVideoQuota: 250,
                resolution: '4K',
                devices: 3,
                ads: false,
                price: '$50/سنة',
                planId: 'P-6V5326030C814122HNAFZAFI',
                features: [
                    '250 فيديو شهرياً',
                    '1,000 صورة 4K شهرياً',
                    '3 أجهزة'
                ]
            },
            'basic-monthly': {
                name: 'الخطة الأساسية الشهرية',
                monthlyImageQuota: 1000,
                monthlyVideoQuota: 250,
                resolution: '4K',
                devices: 3,
                ads: false,
                price: '$5/شهر',
                planId: 'P-6ML527490D2009848NAFY5WA',
                features: [
                    '250 فيديو شهرياً',
                    '1,000 صورة 4K شهرياً',
                    '3 أجهزة'
                ]
            },
            'pro': {
                name: 'الخطة الاحترافية',
                monthlyImageQuota: 5000,
                monthlyVideoQuota: 1000,
                resolution: '8K',
                devices: 10,
                ads: false,
                price: '$100/شهر',
                planId: 'P-5VS57764X8846254FNCLRMMA',
                features: [
                    '1,000 فيديو شهرياً',
                    '5,000 صورة 8K شهرياً',
                    '10 أجهزة'
                ]
            }
        };

        // تبديل بين نماذج تسجيل الدخول والتسجيل
        document.getElementById('show-register').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        });
        
        document.getElementById('show-login').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('register-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
        });
        
        // تسجيل مستخدم جديد
        document.getElementById('register-button').addEventListener('click', function() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!name || !email || !password) {
                document.getElementById('register-error').textContent = 'يرجى ملء جميع الحقول';
                return;
            }
            
            // التحقق من صحة البريد الإلكتروني
            if (!validateEmail(email)) {
                document.getElementById('register-error').textContent = 'يرجى إدخال بريد إلكتروني صالح';
                return;
            }
            
            // التحقق من عدم وجود المستخدم مسبقاً
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            if (users.some(user => user.email === email)) {
                document.getElementById('register-error').textContent = 'البريد الإلكتروني مستخدم بالفعل';
                return;
            }
            
            // إنشاء مستخدم جديد
            const newUser = {
                id: Date.now().toString(),
                name,
                email,
                password,
                plan: 'free',
                usageStats: {
                    currentMonth: {
                        images: 0,
                        videos: 0
                    },
                    total: {
                        images: 0,
                        videos: 0
                    }
                },
                createdAt: new Date().toISOString()
            };
            
            // حفظ المستخدم في localStorage
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            // تسجيل الدخول تلقائياً
            localStorage.setItem('currentUser', JSON.stringify(newUser));
            
            // عرض رسالة نجاح وتوجيه إلى لوحة التحكم
            alert('تم إنشاء الحساب بنجاح!');
            showDashboard();
        });
        
        // تسجيل الدخول
        document.getElementById('login-button').addEventListener('click', function() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                document.getElementById('login-error').textContent = 'يرجى ملء جميع الحقول';
                return;
            }
            
            // التحقق من بيانات المستخدم
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(user => user.email === email && user.password === password);
            
            if (!user) {
                document.getElementById('login-error').textContent = 'البريد الإلكتروني أو كلمة المرور غير صحيحة';
                return;
            }
            
            // حفظ المستخدم الحالي في localStorage
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            // توجيه إلى لوحة التحكم
            showDashboard();
        });
        
        // تسجيل الخروج
        document.getElementById('logout-button').addEventListener('click', function() {
            localStorage.removeItem('currentUser');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
            
            // مسح حقول تسجيل الدخول
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').textContent = '';
        });
        
        // عرض لوحة التحكم
        function showDashboard() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                return;
            }
            
            // إخفاء نماذج تسجيل الدخول والتسجيل
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'none';
            
            // عرض لوحة التحكم
            document.getElementById('dashboard').style.display = 'block';
            
            // تحديث بيانات المستخدم
            document.getElementById('user-name').textContent = 'مرحباً، ' + currentUser.name;
        }
        
        // التحقق من صحة البريد الإلكتروني
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        // التحقق من وجود مستخدم حالي عند تحميل الصفحة
        window.onload = function() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                showDashboard();
            }
            
            // تهيئة المشهد ثلاثي الأبعاد
            initThreeJS();
            
            // تهيئة أزرار PayPal
            initPayPalButtons();
        };
        
        // تهيئة أزرار PayPal
        function initPayPalButtons() {
            // زر الخطة الأساسية الشهرية
            paypal.Buttons({
                createSubscription: function(data, actions) {
                    return actions.subscription.create({
                        'plan_id': plans['basic-monthly'].planId
                    });
                },
                onApprove: function(data, actions) {
                    upgradePlan('basic-monthly');
                    alert('تم الاشتراك بنجاح في الخطة الأساسية الشهرية!');
                    return fetch('/update_subscription.php', {
                        method: 'POST',
                        headers: {
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify({
                            subscriptionID: data.subscriptionID,
                            planId: 'basic-monthly'
                        })
                    });
                },
                style: {
                    shape: 'rect',
                    color: 'blue',
                    layout: 'vertical',
                    label: 'subscribe'
                }
            }).render('#paypal-button-monthly');
            
            // زر الخطة الأساسية السنوية
            paypal.Buttons({
                createSubscription: function(data, actions) {
                    return actions.subscription.create({
                        'plan_id': plans['basic-annual'].planId
                    });
                },
                onApprove: function(data, actions) {
                    upgradePlan('basic-annual');
                    alert('تم الاشتراك بنجاح في الخطة الأساسية السنوية!');
                    return fetch('/update_subscription.php', {
                        method: 'POST',
                        headers: {
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify({
                            subscriptionID: data.subscriptionID,
                            planId: 'basic-annual'
                        })
                    });
                },
                style: {
                    shape: 'rect',
                    color: 'blue',
                    layout: 'vertical',
                    label: 'subscribe'
                }
            }).render('#paypal-button-annual');
            
            // زر الخطة الاحترافية
            paypal.Buttons({
                createSubscription: function(data, actions) {
                    return actions.subscription.create({
                        'plan_id': plans['pro'].planId
                    });
                },
                onApprove: function(data, actions) {
                    upgradePlan('pro');
                    alert('تم الاشتراك بنجاح في الخطة الاحترافية!');
                    return fetch('/update_subscription.php', {
                        method: 'POST',
                        headers: {
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify({
                            subscriptionID: data.subscriptionID,
                            planId: 'pro'
                        })
                    });
                },
                style: {
                    shape: 'rect',
                    color: 'blue',
                    layout: 'vertical',
                    label: 'subscribe'
                }
            }).render('#paypal-button-pro');
        }
        
        // ترقية خطة المستخدم
        function upgradePlan(planId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return;
            
            currentUser.plan = planId;
            
            // تحديث المستخدم في localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // تحديث المستخدم في قائمة المستخدمين
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(user => user.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // تحديث واجهة المستخدم
            function updateDashboardUI() {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (!currentUser) return;
                
                // تحديث اسم المستخدم
                document.getElementById('user-name').textContent = currentUser.email;
                
                // الحصول على معلومات الخطة
                const plan = plans[currentUser.plan];
                
                // تحديث إحصائيات الاستخدام
                document.getElementById('current-plan').textContent = getPlanName(currentUser.plan);
                
                // تحديث عدد الصور المستخدمة مع شريط التقدم
                const imagesUsed = currentUser.usageStats.currentMonth.images;
                const imagesQuota = plan.monthlyImageQuota;
                const imagesPercentage = Math.min((imagesUsed / imagesQuota) * 100, 100);
                
                document.getElementById('images-used').innerHTML = `${imagesUsed} <div class="progress-bar"><div class="progress-fill" style="width: ${imagesPercentage}%"></div></div><div class="limit-text">${imagesUsed} من ${imagesQuota}</div>`;
                
                // تحديث عدد الفيديوهات المستخدمة مع شريط التقدم
                const videosUsed = currentUser.usageStats.currentMonth.videos;
                const videosQuota = plan.monthlyVideoQuota;
                const videosPercentage = Math.min((videosUsed / videosQuota) * 100, 100);
                
                document.getElementById('videos-used').innerHTML = `${videosUsed} <div class="progress-bar"><div class="progress-fill" style="width: ${videosPercentage}%"></div></div><div class="limit-text">${videosUsed} من ${videosQuota}</div>`;
                
                // تحديث إجمالي الاستخدام
                document.getElementById('total-images').textContent = currentUser.usageStats.total.images;
                document.getElementById('total-videos').textContent = currentUser.usageStats.total.videos;
                
                // تحديث معلومات الخطة الإضافية
                document.getElementById('plan-resolution').textContent = plan.resolution || '2K';
                document.getElementById('plan-devices').textContent = plan.devices || '1';
                
                // تحديث حالة الإعلانات
                const adsStatus = plan.ads ? 'مفعلة' : 'غير مفعلة';
                document.getElementById('plan-ads').textContent = adsStatus;
            }
            
            // إرسال بيانات الاستخدام إلى الخادم (في حالة وجود خادم)
            try {
                fetch('/update_usage.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        usageType: type,
                        timestamp: new Date().toISOString()
                    })
                }).catch(err => console.log('خطأ في تحديث الاستخدام على الخادم:', err));
            } catch (e) {
                console.log('لا يمكن الاتصال بالخادم لتحديث الاستخدام');
            }
            
            return true;
        }
        
        // تصدير صورة
        function exportImage() {
            // التحقق من تسجيل الدخول وتحديث عداد الاستخدام
            if (!updateUsageCounter('image')) return;
            
            // عرض مؤشر التحميل
            const exportStatus = document.createElement('div');
            exportStatus.className = 'export-status';
            exportStatus.textContent = 'جاري تصدير الصورة...';
            document.body.appendChild(exportStatus);
            
            // الحصول على الصيغة والأبعاد المختارة
            const fileFormat = document.getElementById('file-format').value;
            const dimensions = document.getElementById('file-dimensions').value.split('x');
            const targetWidth = parseInt(dimensions[0]);
            const targetHeight = parseInt(dimensions[1]);
            
            // تحديد نوع MIME بناءً على الصيغة المختارة
            let mimeType = 'image/png';
            let fileExtension = 'png';
            if (fileFormat === 'jpg') {
                mimeType = 'image/jpeg';
                fileExtension = 'jpg';
            }
            
            // تصدير الصورة بالأبعاد والصيغة المحددة
            setTimeout(() => {
                // حفظ حجم المصير الحالي
                const originalWidth = renderer.domElement.width;
                const originalHeight = renderer.domElement.height;
                
                // ضبط حجم المصير مؤقتًا للحصول على الأبعاد المطلوبة
                renderer.setSize(targetWidth, targetHeight);
                renderer.render(scene, camera);
                
                // تصدير الصورة
                const dataURL = renderer.domElement.toDataURL(mimeType);
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = 'scene-' + Date.now() + '.' + fileExtension;
                link.click();
                
                // إعادة ضبط حجم المصير
                renderer.setSize(originalWidth, originalHeight);
                renderer.render(scene, camera);
                
                // إزالة مؤشر التحميل
                document.body.removeChild(exportStatus);
            }, 100);
        }
        
        // متغير عام لتخزين الفيديو المصدر
        let exportedVideoBlob = null;
        
        // إنشاء نافذة معاينة الفيديو المنبثقة
        function showVideoPreview() {
            // إنشاء عناصر النافذة المنبثقة
            const modal = document.createElement('div');
            modal.id = 'video-preview-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                direction: rtl;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background-color: white;
                padding: 20px;
                border-radius: 8px;
                max-width: 80%;
                max-height: 80%;
                display: flex;
                flex-direction: column;
                align-items: center;
            `;
            
            const videoElement = document.createElement('video');
            videoElement.id = 'video-preview';
            videoElement.controls = true;
            videoElement.style.cssText = `
                max-width: 100%;
                max-height: 60vh;
                margin-bottom: 15px;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 10px;
                margin-top: 10px;
            `;
            
            const downloadButton = document.createElement('button');
            downloadButton.id = 'download-video-btn';
            downloadButton.textContent = 'تنزيل الفيديو';
            downloadButton.className = 'btn btn-primary';
            
            const closeButton = document.createElement('button');
            closeButton.id = 'close-preview-btn';
            closeButton.textContent = 'إغلاق';
            closeButton.className = 'btn btn-secondary';
            
            // إضافة العناصر إلى النافذة
            buttonContainer.appendChild(downloadButton);
            buttonContainer.appendChild(closeButton);
            
            modalContent.appendChild(videoElement);
            modalContent.appendChild(buttonContainer);
            modal.appendChild(modalContent);
            
            // إضافة النافذة إلى الصفحة
            document.body.appendChild(modal);
            
            // تعيين مصدر الفيديو
            const videoUrl = URL.createObjectURL(exportedVideoBlob);
            videoElement.src = videoUrl;
            videoElement.play();
            
            // إضافة مستمعي الأحداث
            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            downloadButton.addEventListener('click', () => {
                const fileFormat = document.getElementById('file-format').value;
                const link = document.createElement('a');
                link.href = videoUrl;
                link.download = 'scene-' + Date.now() + '.' + fileFormat;
                link.click();
            });
        }
        
        // تصدير فيديو
        function exportVideo() {
            // التحقق من تسجيل الدخول وتحديث عداد الاستخدام
            if (!updateUsageCounter('video')) return;
            
            // الحصول على الصيغة والأبعاد المختارة
            const fileFormat = document.getElementById('file-format').value;
            const dimensions = document.getElementById('file-dimensions').value.split('x');
            const targetWidth = parseInt(dimensions[0]);
            const targetHeight = parseInt(dimensions[1]);
            
            // التحقق من أن الصيغة المختارة هي فيديو
            if (fileFormat !== 'webm' && fileFormat !== 'mp4') {
                alert('الرجاء اختيار صيغة فيديو (WEBM أو MP4)');
                return;
            }
            
            // عرض مؤشر التحميل
            const exportStatus = document.createElement('div');
            exportStatus.className = 'export-status';
            exportStatus.textContent = 'جاري تسجيل الفيديو... (5 ثوانٍ)';
            document.body.appendChild(exportStatus);
            
            // حفظ حجم المصير الحالي
            const originalWidth = renderer.domElement.width;
            const originalHeight = renderer.domElement.height;
            
            // ضبط حجم المصير مؤقتًا للحصول على الأبعاد المطلوبة
            renderer.setSize(targetWidth, targetHeight);
            
            // إنشاء مسجل CCapture
            capturer = new CCapture({
                format: fileFormat,
                framerate: 30,
                verbose: true,
                quality: quality * 100,
                name: 'scene-' + Date.now()
            });
            
            // بدء التسجيل
            capturer.start();
            
            // تحديث النص كل ثانية
            let secondsLeft = 3;
            const countdownInterval = setInterval(() => {
                secondsLeft--;
                exportStatus.textContent = `جاري تسجيل الفيديو... (${secondsLeft} ثوانٍ)`;
                if (secondsLeft <= 0) clearInterval(countdownInterval);
            }, 1000);
            
            // إيقاف التسجيل بعد 3 ثوانٍ
            setTimeout(function() {
                capturer.stop();
                exportStatus.textContent = 'جاري معالجة الفيديو...';
                
                // معالجة الفيديو وتنزيله
                capturer.save(function(blob) {
                    // تخزين الفيديو المصدر للمعاينة
                    exportedVideoBlob = blob;
                    const url = URL.createObjectURL(blob);
                    
                    // إظهار زر معاينة الفيديو
                    const previewBtn = document.getElementById('preview-video-btn');
                    if (previewBtn) {
                        previewBtn.style.display = 'inline-block';
                        // إضافة مستمع حدث لزر المعاينة
                        previewBtn.onclick = showVideoPreview;
                    } else {
                        // إنشاء زر معاينة إذا لم يكن موجودًا
                        const previewButton = document.createElement('button');
                        previewButton.id = 'preview-video-btn';
                        previewButton.className = 'btn btn-info';
                        previewButton.textContent = 'معاينة الفيديو';
                        previewButton.style.marginLeft = '10px';
                        previewButton.onclick = showVideoPreview;
                        
                        // إضافة الزر بعد زر تصدير الفيديو
                        const exportBtn = document.getElementById('export-video-btn');
                        exportBtn.parentNode.insertBefore(previewButton, exportBtn.nextSibling);
                    }
                    
                    // تنزيل الفيديو مباشرة
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'scene-' + Date.now() + '.' + fileFormat;
                    link.click();
                    
                    // عائمة ضبط المصير
                    renderer.setSize(originalWidth, originalHeight);
                    renderer.render(scene, camera);
                    
                    // إزالة مؤشر التحميل
                    document.body.removeChild(exportStatus);
                    
                    // تنظيف
                    capturer = null;
                });
            }, 3000);
        }
        
        // تحديث واجهة لوحة التحكم
        function updateDashboardUI() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) return;
            
            const plan = plans[currentUser.plan];
            
            // تحديث اسم الخطة
            document.getElementById('current-plan').textContent = plan.name;
            
            // تحديث عدد الصور المستخدمة مع شريط التقدم
            const imagesUsed = currentUser.usageStats.currentMonth.images;
            const imagesQuota = plan.monthlyImageQuota;
            const imagesPercentage = Math.min((imagesUsed / imagesQuota) * 100, 100);
            
            document.getElementById('images-used').innerHTML = `${imagesUsed} <div class="progress-bar"><div class="progress-fill" style="width: ${imagesPercentage}%"></div></div><div class="limit-text">${imagesUsed} من ${imagesQuota}</div>`;
            
            // تحديث عدد الفيديوهات المستخدمة مع شريط التقدم
            const videosUsed = currentUser.usageStats.currentMonth.videos;
            const videosQuota = plan.monthlyVideoQuota;
            const videosPercentage = Math.min((videosUsed / videosQuota) * 100, 100);
            
            document.getElementById('videos-used').innerHTML = `${videosUsed} <div class="progress-bar"><div class="progress-fill" style="width: ${videosPercentage}%"></div></div><div class="limit-text">${videosUsed} من ${videosQuota}</div>`;
            
            // تحديث إجمالي الاستخدام
            document.getElementById('total-images').textContent = currentUser.usageStats.total.images;
            document.getElementById('total-videos').textContent = currentUser.usageStats.total.videos;
            
            // تحديث معلومات الخطة الإضافية
            document.getElementById('plan-resolution').textContent = plan.resolution || '2K';
            document.getElementById('plan-devices').textContent = plan.devices || '1';
            
            // تحديث حالة الإعلانات
            const adsStatus = plan.ads ? 'مفعلة' : 'غير مفعلة';
            document.getElementById('plan-ads').textContent = adsStatus;
        }
        
        // تحديث عداد الاستخدام
        function updateUsageCounter(type) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('يرجى تسجيل الدخول أولاً');
                return false;
            }
            
            // الحصول على معلومات الخطة
            const plan = plans[currentUser.plan];
            
            // التحقق من حدود الاستخدام
            if (type === 'image' && currentUser.usageStats.currentMonth.images >= plan.monthlyImageQuota) {
                alert('لقد وصلت إلى الحد الأقصى من الصور المسموح بها هذا الشهر. يرجى ترقية خطتك للحصول على المزيد.');
                return false;
            } else if (type === 'video' && currentUser.usageStats.currentMonth.videos >= plan.monthlyVideoQuota) {
                alert('لقد وصلت إلى الحد الأقصى من الفيديوهات المسموح بها هذا الشهر. يرجى ترقية خطتك للحصول على المزيد.');
                return false;
            }
            
            // زيادة عداد الاستخدام
            if (type === 'image') {
                currentUser.usageStats.currentMonth.images++;
                currentUser.usageStats.total.images++;
            } else if (type === 'video') {
                currentUser.usageStats.currentMonth.videos++;
                currentUser.usageStats.total.videos++;
            }
            
            // تحديث المستخدم في localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // تحديث المستخدم في قائمة المستخدمين
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(user => user.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // تحديث واجهة المستخدم
            updateDashboardUI();
            
            // إرسال بيانات الاستخدام إلى الخادم (في حالة وجود خادم)
            try {
                fetch('/update_usage.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        usageType: type,
                        timestamp: new Date().toISOString()
                    })
                }).catch(err => console.log('خطأ في تحديث الاستخدام على الخادم:', err));
            } catch (e) {
                console.log('لا يمكن الاتصال بالخادم لتحديث الاستخدام');
            }
            
            return true;
        }
        
        // متغيرات Three.js
        let scene, camera, renderer, controls, model, mixer, clock, capturer;
        
        // تهيئة Three.js
        function initThreeJS() {
            // إنشاء المشهد
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            
            // إضافة إضاءة
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // إنشاء الكاميرا
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1, 5);
            
            // إنشاء المصير (renderer)
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(800, 400);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // إضافة المصير إلى الصفحة
            const container = document.getElementById('scene-container');
            if (container) {
                container.innerHTML = '';
                container.appendChild(renderer.domElement);
            }
            
            // إضافة التحكم بالكاميرا
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // إنشاء الساعة للرسوم المتحركة
            clock = new THREE.Clock();
            
            // تحميل نموذج GLTF
            const loader = new THREE.GLTFLoader();
            loader.load(
                // مسار النموذج - يمكن تغييره حسب النموذج المتاح
                'https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf',
                function(gltf) {
                    model = gltf.scene;
                    model.scale.set(2, 2, 2);
                    scene.add(model);
                    
                    // إضافة الرسوم المتحركة إذا كانت موجودة
                    if (gltf.animations && gltf.animations.length) {
                        mixer = new THREE.AnimationMixer(model);
                        const action = mixer.clipAction(gltf.animations[0]);
                        action.play();
                    }
                    
                    // تحديث التحكم بالكاميرا
                    controls.update();
                },
                function(xhr) {
                    console.log((xhr.loaded / xhr.total * 100) + '% تم تحميل النموذج');
                },
                function(error) {
                    console.error('حدث خطأ أثناء تحميل النموذج:', error);
                    
                    // إنشاء نموذج بديل في حالة فشل التحميل
                    const geometry = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
                    const material = new THREE.MeshStandardMaterial({ 
                        color: 0x049ef4,
                        roughness: 0.5,
                        metalness: 0.7
                    });
                    const torusKnot = new THREE.Mesh(geometry, material);
                    scene.add(torusKnot);
                    model = torusKnot;
                }
            );
            
            // إضافة مستمع لتغيير حجم النافذة
            window.addEventListener('resize', onWindowResize);
            
            // بدء حلقة الرسم
            animate();
            
            // إضافة أحداث لأزرار التصدير
            document.getElementById('export-image-btn').addEventListener('click', exportImage);
            document.getElementById('export-video-btn').addEventListener('click', exportVideo);
            
            // إضافة حدث لزر الخروج
            document.getElementById('logout-btn').addEventListener('click', function() {
                localStorage.removeItem('currentUser');
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('login-form').style.display = 'block';
                
                // مسح حقول تسجيل الدخول
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                document.getElementById('login-error').textContent = '';
            });
        }
        
        // تعديل حجم المصير عند تغيير حجم النافذة
        function onWindowResize() {
            const container = document.getElementById('scene-container');
            if (!container) return;
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            
            renderer.setSize(width, height);
        }
        
        // حلقة الرسم
        function animate() {
            requestAnimationFrame(animate);
            
            // تحديث التحكم بالكاميرا
            if (controls) controls.update();
            
            // تحديث الرسوم المتحركة
            if (mixer) mixer.update(clock.getDelta());
            
            // تدوير النموذج إذا كان موجودًا
            if (model) model.rotation.y += 0.005;
            
            // تسجيل إطار للفيديو إذا كان التسجيل نشطًا
            if (capturer) capturer.capture(renderer.domElement);
            
            // عرض المشهد
            renderer.render(scene, camera);
        }
        
        // عرض/إخفاء قائمة الخطط
        document.getElementById('upgrade-btn').addEventListener('click', function() {
            // هنا يمكن إضافة كود لعرض قائمة الخطط
            alert('سيتم إضافة قائمة الخطط قريبًا');
        });